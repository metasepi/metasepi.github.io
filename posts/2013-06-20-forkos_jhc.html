<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>Build forkOS API using pthread. - Metasepi</title>

  <meta name="description" content="metasepi.org">
  <meta name="author" content="Kiwamu Okabe">

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="http://metasepi.org/rss_en.xml" rel="alternate" title="Blog" type="application/rss+xml">

  <!-- CSS concatenated and minified via ant build script-->
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/syntax.css">
  <link rel="stylesheet" href="../css/calendar.css">
  <!-- end CSS-->

  <link rel="stylesheet" href="../css/default.css">

  <script src="../js/libs/modernizr-2.0.6.min.js"></script>
</head>

<body onload="prettyPrint()">
  <div id="fb-root"></div>
  <script>
    (function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) {return;}
      js = d.createElement(s); js.id = id;
      js.src = '//connect.facebook.net/ja_JP/all.js#xfbml=1';
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
  </script>

  <header class="topbar">
    <div class="container">
      <div class="brand">
        <a href="../">Metasepi</a>
      </div>

      <div class="nav">
        <li><a href="../">Home</a></li>
        <li><a href="../en/posts.html">Blog</a></li>
        <li><a href="../papers.html">Papers</a></li>
        <li><a href="../map.html">Map</a></li>
        <li><a href="../memories.html">Memories</a></li>
        <li><a href="../about.html">About</a></li>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="content clearfix">
      <h1>Build forkOS API using pthread.</h1>
<div class="info">Posted on June 20, 2013 / Tags: <a href="../tags/jhc.html">jhc</a>, <a href="../tags/ajhc.html">ajhc</a>, <a href="../tags/thread.html">thread</a>, <a href="../tags/pthread.html">pthread</a></div>
<h2>Table of contents</h2>
<ul>
<li><a href="#作成方法を考えよう">作成方法を考えよう</a><ul>
<li><a href="#ghc-baseパッケージの設計をまねる">(1) GHC baseパッケージの設計をまねる</a></li>
<li><a href="#foreign-import-ccall-wrapperで関数ポインタを作る">(2) foreign import ccall “wrapper”で関数ポインタを作る</a></li>
<li><a href="#グローバル関数テーブルのインデックスを引数渡し">(3) グローバル関数テーブルのインデックスを引数渡し</a></li>
<li><a href="#ラムダ式を使うために-stdgnu11でコンパイル">(4) ラムダ式を使うために-std=gnu++11でコンパイル</a></li>
</ul></li>
<li><a href="#結論-やはりnewstableptrに直接io-を突っ込んだ際の挙動を観察するべき">結論: やはりnewStablePtrに直接IO ()を突っ込んだ際の挙動を観察するべき</a></li>
<li><a href="#実装">実装</a></li>
</ul>
<hr>
<p>再入可能にしようとして、まずは <a href="http://hackage.haskell.org/packages/archive/base/latest/doc/html/Control-Concurrent.html#v:forkOS">forkOS</a> を作ろうとしたらハマったでゲソ。 このページはforkOSをpthread_createを使って作るメモ書きでゲソ。</p>
<h2 id="作成方法を考えよう">作成方法を考えよう</h2>
<p>作る前にまずは作戦をねるでゲソー。</p>
<h3 id="ghc-baseパッケージの設計をまねる">(1) GHC baseパッケージの設計をまねる</h3>
<p><a href="http://hackage.haskell.org/packages/archive/base/latest/doc/html/src/Control-Concurrent.html#forkOS">GHCでのforkOSの実装</a> を見ると、StablePtrにIO関数を包んで、C言語のforkOS_createThread関数に渡しているでゲソ。 pthread_createは</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1"></a><span class="co">-- File: ghc/libraries/base/Control/Concurrent.hs</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>foreign export ccall forkOS_entry</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="ot">    ::</span> <span class="dt">StablePtr</span> (<span class="dt">IO</span> ()) <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a>foreign <span class="kw">import</span> ccall &quot;forkOS_entry&quot; forkOS_entry_reimported</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="ot">    ::</span> <span class="dt">StablePtr</span> (<span class="dt">IO</span> ()) <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb1-7"><a href="#cb1-7"></a></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="ot">forkOS_entry ::</span> <span class="dt">StablePtr</span> (<span class="dt">IO</span> ()) <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb1-9"><a href="#cb1-9"></a>forkOS_entry stableAction <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>        action <span class="ot">&lt;-</span> deRefStablePtr stableAction</span>
<span id="cb1-11"><a href="#cb1-11"></a>        action</span>
<span id="cb1-12"><a href="#cb1-12"></a></span>
<span id="cb1-13"><a href="#cb1-13"></a>foreign <span class="kw">import</span> ccall forkOS_createThread</span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="ot">    ::</span> <span class="dt">StablePtr</span> (<span class="dt">IO</span> ()) <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">CInt</span></span>
<span id="cb1-15"><a href="#cb1-15"></a></span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="ot">forkOS ::</span> <span class="dt">IO</span> () <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">ThreadId</span></span>
<span id="cb1-17"><a href="#cb1-17"></a>forkOS action0</span>
<span id="cb1-18"><a href="#cb1-18"></a>    <span class="op">|</span> rtsSupportsBoundThreads <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="co">-- snip --</span></span>
<span id="cb1-20"><a href="#cb1-20"></a>        entry <span class="ot">&lt;-</span> newStablePtr (myThreadId <span class="op">&gt;&gt;=</span> putMVar mv <span class="op">&gt;&gt;</span> action_plus)</span>
<span id="cb1-21"><a href="#cb1-21"></a>        err <span class="ot">&lt;-</span> forkOS_createThread entry</span>
<span id="cb1-22"><a href="#cb1-22"></a>        when (err <span class="op">/=</span> <span class="dv">0</span>) <span class="op">$</span> <span class="fu">fail</span> <span class="st">&quot;Cannot create OS thread.&quot;</span></span>
<span id="cb1-23"><a href="#cb1-23"></a>        tid <span class="ot">&lt;-</span> takeMVar mv</span>
<span id="cb1-24"><a href="#cb1-24"></a>        freeStablePtr entry</span>
<span id="cb1-25"><a href="#cb1-25"></a>        <span class="fu">return</span> tid</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1"></a><span class="co">/* File: ghc/rts/posix/OSThreads.c */</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="dt">static</span> <span class="dt">void</span> *</span>
<span id="cb2-3"><a href="#cb2-3"></a>forkOS_createThreadWrapper ( <span class="dt">void</span> * entry )</span>
<span id="cb2-4"><a href="#cb2-4"></a>{</span>
<span id="cb2-5"><a href="#cb2-5"></a>    Capability *cap;</span>
<span id="cb2-6"><a href="#cb2-6"></a>    cap = rts_lock();</span>
<span id="cb2-7"><a href="#cb2-7"></a>    rts_evalStableIO(&amp;cap, (HsStablePtr) entry, NULL);</span>
<span id="cb2-8"><a href="#cb2-8"></a>    rts_unlock(cap);</span>
<span id="cb2-9"><a href="#cb2-9"></a>    <span class="cf">return</span> NULL;</span>
<span id="cb2-10"><a href="#cb2-10"></a>}</span>
<span id="cb2-11"><a href="#cb2-11"></a></span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="dt">int</span></span>
<span id="cb2-13"><a href="#cb2-13"></a>forkOS_createThread ( HsStablePtr entry )</span>
<span id="cb2-14"><a href="#cb2-14"></a>{</span>
<span id="cb2-15"><a href="#cb2-15"></a>    pthread_t tid;</span>
<span id="cb2-16"><a href="#cb2-16"></a>    <span class="dt">int</span> result = pthread_create(&amp;tid, NULL,</span>
<span id="cb2-17"><a href="#cb2-17"></a>				forkOS_createThreadWrapper, (<span class="dt">void</span>*)entry);</span>
<span id="cb2-18"><a href="#cb2-18"></a>    <span class="cf">if</span>(!result)</span>
<span id="cb2-19"><a href="#cb2-19"></a>        pthread_detach(tid);</span>
<span id="cb2-20"><a href="#cb2-20"></a>    <span class="cf">return</span> result;</span>
<span id="cb2-21"><a href="#cb2-21"></a>}</span></code></pre></div>
<p>どうやらGHCではStablePtrはFFIを越えることができて、その型はHsStablePtrのようでゲソ。 このようなコードをAjhcでも実現できなイカ？ ところが <a href="https://github.com/ajhc/ajhc-dumpyard/tree/master/try_pthread1">それぽいコード</a> を書いてみたところエラーになるじゃなイカ。 これはStablePtrは単なるスマートポインタになるはずでゲソが、 どうもこのスマートポインタを直接C言語コードに渡すのが禁止されているようでゲソ。</p>
<pre><code>$ make
--snip--
Compiling...
[1 of 1] Jhc.Conc         
jhc-conc-pthread/Jhc/Conc.hs:28  - Error: caught error processing decl: user error (createFunc: attempt to pass a void argument)
jhc-conc-pthread/Jhc/Conc.hs:28  - Error: Type 'Foreign.StablePtr.StablePtr (IO ())' cannot be used in a foreign declaration</code></pre>
<p>このスマートポインタを直接C言語コードに見せる行為をはたして許して良いものか考えどころでゲソ。。。 イカはforeignで使って良い要素を判定している箇所の抜き出しでゲソ。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1"></a><span class="co">-- File: ajhc/src/E/FromHs.hs</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="kw">instance</span> <span class="dt">DataTableMonad</span> <span class="dt">C</span> <span class="kw">where</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>    getDataTable <span class="ot">=</span> asks ceDataTable</span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a>ffiTypeInfo bad t cont <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>    dataTable <span class="ot">&lt;-</span> getDataTable</span>
<span id="cb4-7"><a href="#cb4-7"></a>    <span class="kw">case</span> lookupExtTypeInfo dataTable t <span class="kw">of</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>        <span class="dt">Just</span> r <span class="ot">-&gt;</span> cont r</span>
<span id="cb4-9"><a href="#cb4-9"></a>        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb4-10"><a href="#cb4-10"></a>            sl <span class="ot">&lt;-</span> getSrcLoc</span>
<span id="cb4-11"><a href="#cb4-11"></a>            liftIO <span class="op">$</span> warn sl <span class="dt">InvalidFFIType</span> <span class="op">$</span> printf <span class="st">&quot;Type '%s' cannot be used in a foreign declaration&quot;</span> (pprint<span class="ot"> t ::</span> <span class="dt">String</span>)</span>
<span id="cb4-12"><a href="#cb4-12"></a>            <span class="fu">return</span> bad</span>
<span id="cb4-13"><a href="#cb4-13"></a></span>
<span id="cb4-14"><a href="#cb4-14"></a>convertDecls tiData props classHierarchy assumps dataTable hsDecls <span class="ot">=</span> res <span class="kw">where</span></span>
<span id="cb4-15"><a href="#cb4-15"></a>    res <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb4-16"><a href="#cb4-16"></a>        (a,ws) <span class="ot">&lt;-</span> evalRWST ans ceEnv <span class="dv">2</span></span>
<span id="cb4-17"><a href="#cb4-17"></a>        <span class="fu">mapM_</span> addWarning ws</span>
<span id="cb4-18"><a href="#cb4-18"></a>        <span class="fu">return</span> a</span>
<span id="cb4-19"><a href="#cb4-19"></a>    ceEnv <span class="ot">=</span> <span class="dt">CeEnv</span> {</span>
<span id="cb4-20"><a href="#cb4-20"></a>        ceCoerce <span class="ot">=</span> tiCoerce tiData,</span>
<span id="cb4-21"><a href="#cb4-21"></a>        ceAssumps <span class="ot">=</span> assumps,</span>
<span id="cb4-22"><a href="#cb4-22"></a>        ceFuncs <span class="ot">=</span> funcs,</span>
<span id="cb4-23"><a href="#cb4-23"></a>        ceProps <span class="ot">=</span> props,</span>
<span id="cb4-24"><a href="#cb4-24"></a>        ceSrcLoc <span class="ot">=</span> bogusASrcLoc,</span>
<span id="cb4-25"><a href="#cb4-25"></a>        ceDataTable <span class="ot">=</span> dataTable</span>
<span id="cb4-26"><a href="#cb4-26"></a>        }</span>
<span id="cb4-27"><a href="#cb4-27"></a></span>
<span id="cb4-28"><a href="#cb4-28"></a><span class="co">-- File: ajhc/src/E/Main.hs</span></span>
<span id="cb4-29"><a href="#cb4-29"></a><span class="ot">processDecls ::</span></span>
<span id="cb4-30"><a href="#cb4-30"></a>    <span class="dt">CollectedHo</span>             <span class="co">-- ^ Collected ho</span></span>
<span id="cb4-31"><a href="#cb4-31"></a>    <span class="ot">-&gt;</span> <span class="dt">Ho</span>                   <span class="co">-- ^ preliminary haskell object  data</span></span>
<span id="cb4-32"><a href="#cb4-32"></a>    <span class="ot">-&gt;</span> <span class="dt">TiData</span>               <span class="co">-- ^ front end output</span></span>
<span id="cb4-33"><a href="#cb4-33"></a>    <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">CollectedHo</span>,<span class="dt">Ho</span>)  <span class="co">-- ^ (new accumulated ho, final ho for this modules)</span></span>
<span id="cb4-34"><a href="#cb4-34"></a>processDecls cho ho' tiData <span class="ot">=</span> withStackStatus <span class="st">&quot;processDecls&quot;</span> <span class="op">$</span>  <span class="kw">do</span></span>
<span id="cb4-35"><a href="#cb4-35"></a><span class="co">--snip--</span></span>
<span id="cb4-36"><a href="#cb4-36"></a>    <span class="kw">let</span> derives <span class="ot">=</span> (collectDeriving originalDecls)</span>
<span id="cb4-37"><a href="#cb4-37"></a>    <span class="kw">let</span> dataTable <span class="ot">=</span> toDataTable (getConstructorKinds (hoKinds <span class="op">$</span> hoTcInfo ho'))</span>
<span id="cb4-38"><a href="#cb4-38"></a>            (tiAllAssumptions tiData) originalDecls (hoDataTable <span class="op">$</span> hoBuild ho)</span>
<span id="cb4-39"><a href="#cb4-39"></a>        classInstances <span class="ot">=</span> deriveClasses (choCombinators cho) fullDataTable derives</span>
<span id="cb4-40"><a href="#cb4-40"></a>        fullDataTable <span class="ot">=</span> dataTable <span class="ot">`mappend`</span> hoDataTable (hoBuild ho)</span>
<span id="cb4-41"><a href="#cb4-41"></a><span class="co">--snip--</span></span>
<span id="cb4-42"><a href="#cb4-42"></a>    ds' <span class="ot">&lt;-</span> convertDecls tiData theProps</span>
<span id="cb4-43"><a href="#cb4-43"></a>        (hoClassHierarchy <span class="op">$</span> hoTcInfo ho') allAssumps  fullDataTable decls</span></code></pre></div>
<p>もう一つ気になるのはdeRefStablePtrを使ってIOを元に戻しても実行不能という点でゲソ。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">import</span> <span class="dt">Foreign.StablePtr</span></span>
<span id="cb5-2"><a href="#cb5-2"></a></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb5-4"><a href="#cb5-4"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>  p <span class="ot">&lt;-</span> newStablePtr <span class="op">$</span> <span class="fu">print</span> <span class="st">&quot;hoge&quot;</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>  d <span class="ot">&lt;-</span> deRefStablePtr p</span>
<span id="cb5-7"><a href="#cb5-7"></a>  d</span></code></pre></div>
<p>上のコードをコンパイルすると、イカのようなエラーになるでゲソ。</p>
<pre><code>$ ajhc --tdir=tmp -o Main Main.hs
--snip--
Typechecking...
Compiling...
Collected Compilation...
-- TypeAnalyzeMethods
-- BoxifyProgram
-- Boxy WorkWrap
-- LambdaLift
Converting to Grin...
Updatable CAFS: 0
Constant CAFS:  0
Recursive CAFS: 0
Exiting abnormally. Work directory is 'tmp'
ajhc: Grin.FromE.compile'.ce in function: theMain
can't grok expression: &lt;fromBang_ x128471745∷IO ()&gt; x62470114</code></pre>
<h3 id="foreign-import-ccall-wrapperで関数ポインタを作る">(2) foreign import ccall “wrapper”で関数ポインタを作る</h3>
<p>wrapperというforeign import宣言 <a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> があり、これを使えば任意のIOを関数ポインタに変換することができるようでゲソ。 wrapperを使えば簡単にpthread_createにHaskellのIOを呼び出してもらえるじゃなイカ？ やってみるでゲソ!</p>
<p>…と、 <a href="https://github.com/ajhc/ajhc-dumpyard/tree/master/try_pthread2">ものすごくいい加減なコード</a> を書いてみたでゲソ。 ところが今度はFunPtrというC言語の型がみつからないとGCCに怒られるでゲソ。</p>
<pre><code>Running: gcc tmp/rts/profile.c tmp/rts/rts_support.c tmp/rts/gc_none.c tmp/rts/jhc_rts.c tmp/lib/lib_cbits.c tmp/rts/gc_jgc.c tmp/rts/stableptr.c -Itmp/cbits -Itmp tmp/main_code.c -o Main '-std=gnu99' -D_GNU_SOURCE '-falign-functions=4' -ffast-math -Wextra -Wall -Wno-unused-parameter -fno-strict-aliasing -DNDEBUG -O3 '-D_JHC_GC=_JHC_GC_JGC'
tmp/main_code.c: In function ‘fFE$__CCall_testThread’:
tmp/main_code.c:659:17: warning: statement with no effect [-Wunused-value]
tmp/main_code.c: In function ‘ftheMain’:
tmp/main_code.c:1146:68: error: ‘FunPtr’ undeclared (first use in this function)
tmp/main_code.c:1146:68: note: each undeclared identifier is reported only once for each function it appears in
Exiting abnormally. Work directory is 'tmp'
ajhc: user error (C code did not compile.)</code></pre>
<p>これはイカのようなC言語コードをAjhcが吐き出すためでゲソ。 もうちょっと小細工すれば関数ポインタが使えるようになりそうじゃなイカ？</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb8-1"><a href="#cb8-1"></a><span class="dt">static</span> <span class="dt">void</span> A_STD</span>
<span id="cb8-2"><a href="#cb8-2"></a>ftheMain(gc_t gc)</span>
<span id="cb8-3"><a href="#cb8-3"></a>{</span>
<span id="cb8-4"><a href="#cb8-4"></a>        saved_gc = gc;</span>
<span id="cb8-5"><a href="#cb8-5"></a>        (<span class="dt">uint32_t</span>)pthread_create((pthread_t*)<span class="dv">0</span>,(pthread_attr_t*)<span class="dv">0</span>,(FunPtr)((<span class="dt">uintptr_t</span>)&amp;testThread),(HsPtr)<span class="dv">0</span>);</span>
<span id="cb8-6"><a href="#cb8-6"></a>        <span class="cf">return</span>;</span>
<span id="cb8-7"><a href="#cb8-7"></a>}</span>
<span id="cb8-8"><a href="#cb8-8"></a></span>
<span id="cb8-9"><a href="#cb8-9"></a>HsPtr</span>
<span id="cb8-10"><a href="#cb8-10"></a>testThread(HsPtr x30)</span>
<span id="cb8-11"><a href="#cb8-11"></a>{</span>
<span id="cb8-12"><a href="#cb8-12"></a>        <span class="cf">return</span> (HsPtr)fFE$__CCall_testThread(saved_gc,(<span class="dt">uintptr_t</span>)x30);</span>
<span id="cb8-13"><a href="#cb8-13"></a>}</span></code></pre></div>
<p>どうも上の不具合はイカのpatchで簡単に修正できるようでゲソ。たぶんこれはイージーミスだと思うでゲソ。</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">--- a/lib/jhc/Jhc/Type/Ptr.hs</span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="dt">+++ b/lib/jhc/Jhc/Type/Ptr.hs</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="dt">@@ -3,4 +3,4 @@ module Jhc.Type.Ptr where</span></span>
<span id="cb9-4"><a href="#cb9-4"></a> import Jhc.Prim.Bits</span>
<span id="cb9-5"><a href="#cb9-5"></a></span>
<span id="cb9-6"><a href="#cb9-6"></a> data {-# CTYPE &quot;HsPtr&quot; #-} Ptr a = Ptr Addr_</span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="st">-data {-# CTYPE &quot;FunPtr&quot; #-} FunPtr a = FunPtr FunAddr_</span></span>
<span id="cb9-8"><a href="#cb9-8"></a><span class="va">+data {-# CTYPE &quot;HsFunPtr&quot; #-} FunPtr a = FunPtr FunAddr_</span></span></code></pre></div>
<p>しかしこれでFunPtrを使った関数ポインタを実現できたんでゲソが、 任意のIOを関数ポインタ化できることにはならないでゲソ。 具体的にはイカのような型になってしまっているforkOSの引数をIO ()にしたいでゲソ。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1"></a><span class="ot">forkOS ::</span> <span class="dt">FunPtr</span> (<span class="dt">Ptr</span> () <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Ptr</span> ())) <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Int</span></span></code></pre></div>
<p>GHCはどんな魔法を使っているのでゲソ？ <a href="https://github.com/ajhc/ajhc-dumpyard/tree/master/ghc_foreign_wrapper">GHCでforeign import ccall “wrapper”を使う例</a> を解析すれば何かわかるかもしれないでゲソ。 freeHaskellFunPtrの行方を探ったところ、 どうもghc/rts/Adjustor.cでwrapperが作ったコード片のラッパーを作るようでゲソ。 createAdjustorというのが主犯のようじゃなイカ。</p>
<p>とりあえず任意のIOをFunPtrに変換するのはキツいにしても、 定数的なIOはラベルをふるだけなのだから比較的簡単にFunPtr化できるんじゃなイカ？</p>
<p><a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/Rts/FFI">Commentary/Rts/FFI – GHC</a> を読んでみたでゲソが、具体的な実現方法については言及がないでゲソ。</p>
<h3 id="グローバル関数テーブルのインデックスを引数渡し">(3) グローバル関数テーブルのインデックスを引数渡し</h3>
<p>StablePtrを使わずにコンテキスト間でIOを授受する方法として無理矢理考えてみたでゲソ。 結局インデックスの意味がC言語側に漏れるので、 StablePtrを直接C言語に渡すケースと比較して危険度はほとんど変わらない気もするでゲソ…</p>
<h3 id="ラムダ式を使うために-stdgnu11でコンパイル">(4) ラムダ式を使うために-std=gnu++11でコンパイル</h3>
<p>さすがにこれは筋が悪すぎるので、困った時の隠し玉に取っておかなイカ？</p>
<h2 id="結論-やはりnewstableptrに直接io-を突っ込んだ際の挙動を観察するべき">結論: やはりnewStablePtrに直接IO ()を突っ込んだ際の挙動を観察するべき</h2>
<pre><code>ajhc: Grin.FromE.compile'.ce in function: theMain
can't grok expression: &lt;fromBang_ x128471745∷IO ()&gt; x62470114</code></pre>
<p>このメッセージはcompile’関数が以下の型を意図せず受け取ったことをしめしているでゲソ。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1"></a>(<span class="dt">EAp</span> (<span class="dt">EPrim</span> (<span class="dt">PrimPrim</span> <span class="st">&quot;fromBang_&quot;</span>) [x] e1) e2)</span></code></pre></div>
<p>ということはこのEApという型はどこかで変換されるべきで、そのしくみから漏れてきたと考えられるじゃなイカ。 しかし仮にイカのようなpatchをあてても…</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb13-1"><a href="#cb13-1"></a><span class="kw">--- a/lib/haskell-extras/Foreign/StablePtr.hs</span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="dt">+++ b/lib/haskell-extras/Foreign/StablePtr.hs</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="dt">@@ -5,7 +5,9 @@ module Foreign.StablePtr(</span></span>
<span id="cb13-4"><a href="#cb13-4"></a>     castPtrToStablePtr,</span>
<span id="cb13-5"><a href="#cb13-5"></a>     newStablePtr,</span>
<span id="cb13-6"><a href="#cb13-6"></a>     deRefStablePtr,</span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="st">-    freeStablePtr</span></span>
<span id="cb13-8"><a href="#cb13-8"></a><span class="va">+    freeStablePtr,</span></span>
<span id="cb13-9"><a href="#cb13-9"></a><span class="va">+    newStablePtrIO,</span></span>
<span id="cb13-10"><a href="#cb13-10"></a><span class="va">+    deRefStablePtrIO,</span></span>
<span id="cb13-11"><a href="#cb13-11"></a>     ) where</span>
<span id="cb13-12"><a href="#cb13-12"></a> </span>
<span id="cb13-13"><a href="#cb13-13"></a> import Jhc.Prim.Rts</span>
<span id="cb13-14"><a href="#cb13-14"></a><span class="dt">@@ -37,6 +39,19 @@ deRefStablePtr x = do</span></span>
<span id="cb13-15"><a href="#cb13-15"></a>     fromUIO $ \w -&gt; case c_derefStablePtr (toBang_ x) w of</span>
<span id="cb13-16"><a href="#cb13-16"></a>         (# w', s #) -&gt; (# w', fromBang_ s #)</span>
<span id="cb13-17"><a href="#cb13-17"></a> </span>
<span id="cb13-18"><a href="#cb13-18"></a><span class="va">+newStablePtrIO :: IO a -&gt; IO (StablePtr (IO a))</span></span>
<span id="cb13-19"><a href="#cb13-19"></a><span class="va">+newStablePtrIO x = do</span></span>
<span id="cb13-20"><a href="#cb13-20"></a><span class="va">+    fromUIO $ \w -&gt; case c_newStablePtrIO x w of</span></span>
<span id="cb13-21"><a href="#cb13-21"></a><span class="va">+        (# w', s #) -&gt; (# w', s #)</span></span>
<span id="cb13-22"><a href="#cb13-22"></a><span class="va">+</span></span>
<span id="cb13-23"><a href="#cb13-23"></a><span class="va">+deRefStablePtrIO :: StablePtr (IO a) -&gt; IO (IO a)</span></span>
<span id="cb13-24"><a href="#cb13-24"></a><span class="va">+deRefStablePtrIO x = do</span></span>
<span id="cb13-25"><a href="#cb13-25"></a><span class="va">+    fromUIO $ \w -&gt; case c_derefStablePtrIO x w of</span></span>
<span id="cb13-26"><a href="#cb13-26"></a><span class="va">+        (# w', s #) -&gt; (# w', s #)</span></span>
<span id="cb13-27"><a href="#cb13-27"></a><span class="va">+</span></span>
<span id="cb13-28"><a href="#cb13-28"></a> foreign import ccall unsafe &quot;rts/stableptr.c c_freeStablePtr&quot;  c_freeStablePtr   :: Bang_ (StablePtr a) -&gt; IO ()</span>
<span id="cb13-29"><a href="#cb13-29"></a> foreign import ccall unsafe &quot;rts/stableptr.c c_newStablePtr&quot;   c_newStablePtr    :: Bang_ a -&gt; UIO (Bang_ (StablePtr a))</span>
<span id="cb13-30"><a href="#cb13-30"></a> foreign import ccall unsafe &quot;rts/stableptr.c c_derefStablePtr&quot; c_derefStablePtr :: Bang_ (StablePtr a) -&gt; UIO (Bang_ a)</span>
<span id="cb13-31"><a href="#cb13-31"></a><span class="va">+</span></span>
<span id="cb13-32"><a href="#cb13-32"></a><span class="va">+foreign import ccall unsafe &quot;rts/stableptr.c c_newStablePtr&quot;   c_newStablePtrIO   :: IO a -&gt; UIO (StablePtr (IO a))</span></span>
<span id="cb13-33"><a href="#cb13-33"></a><span class="va">+foreign import ccall unsafe &quot;rts/stableptr.c c_derefStablePtr&quot; c_derefStablePtrIO :: StablePtr (IO a) -&gt; UIO (IO a)</span></span></code></pre></div>
<p>ajhcのコンパイルでイカのようにエラーになってしまうでゲソ。 どうやらforeign importに渡せる型は限定されているようでゲソ。</p>
<pre><code>Compiling...
[1 of 4] Foreign.StablePtr
lib/haskell-extras/Foreign/StablePtr.hs:56  - Error: Type 'Foreign.StablePtr.StablePtr (IO Foreign.StablePtr.37_a)' cannot be used in a foreign declaration
lib/haskell-extras/Foreign/StablePtr.hs:57  - Error: Type 'IO Foreign.StablePtr.39_a' cannot be used in a foreign declaration
make[2]: *** [haskell-extras-0.8.1.hl] エラー 1</code></pre>
<p>じゃあUIOを経由してStablePtrを作るのはどーなんでゲソ？</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1"></a><span class="ot">newStablePtrIO ::</span> <span class="dt">IO</span> a <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">StablePtr</span> (<span class="dt">UIO</span> a))</span>
<span id="cb15-2"><a href="#cb15-2"></a>newStablePtrIO x <span class="ot">=</span> newStablePtr (unIO x)</span>
<span id="cb15-3"><a href="#cb15-3"></a></span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="ot">deRefStablePtrIO ::</span> <span class="dt">StablePtr</span> (<span class="dt">UIO</span> a) <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">IO</span> a)</span>
<span id="cb15-5"><a href="#cb15-5"></a>deRefStablePtrIO x <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb15-6"><a href="#cb15-6"></a>  u <span class="ot">&lt;-</span> deRefStablePtr x</span>
<span id="cb15-7"><a href="#cb15-7"></a>  <span class="fu">return</span> <span class="op">$</span> fromUIO u</span></code></pre></div>
<p>エラーは変化せず、そりゃそうカー。</p>
<p>ちょっと立ち返って、StablePtrを経由したIO ()の授受というのは本来どのようなコードになるべきなんでゲソ？ イカのようなコード、つまりIO ()をStablePtrとBang_で二重に包んだような型を作り、 この型をpthread_create()で生成されるスレッドに渡して復元してほしいでゲソ。</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1"></a><span class="kw">import</span> <span class="dt">Foreign.StablePtr</span></span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="kw">import</span> <span class="dt">Jhc.Prim.Rts</span></span>
<span id="cb16-3"><a href="#cb16-3"></a></span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="ot">iToB ::</span> <span class="dt">IO</span> () <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Bang_</span> (<span class="dt">StablePtr</span> (<span class="dt">IO</span> ())))</span>
<span id="cb16-5"><a href="#cb16-5"></a>iToB io <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb16-6"><a href="#cb16-6"></a>  s <span class="ot">&lt;-</span> newStablePtr io</span>
<span id="cb16-7"><a href="#cb16-7"></a>  <span class="fu">return</span> <span class="op">$</span> toBang_ s</span>
<span id="cb16-8"><a href="#cb16-8"></a></span>
<span id="cb16-9"><a href="#cb16-9"></a><span class="ot">runB ::</span> <span class="dt">Bang_</span> (<span class="dt">StablePtr</span> (<span class="dt">IO</span> ())) <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb16-10"><a href="#cb16-10"></a>runB b <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb16-11"><a href="#cb16-11"></a>  io <span class="ot">&lt;-</span> deRefStablePtr <span class="op">$</span> fromBang_ b</span>
<span id="cb16-12"><a href="#cb16-12"></a>  io</span>
<span id="cb16-13"><a href="#cb16-13"></a></span>
<span id="cb16-14"><a href="#cb16-14"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb16-15"><a href="#cb16-15"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb16-16"><a href="#cb16-16"></a>  l <span class="ot">&lt;-</span> <span class="fu">getLine</span></span>
<span id="cb16-17"><a href="#cb16-17"></a>  b <span class="ot">&lt;-</span> iToB <span class="op">$</span> <span class="fu">print</span> l</span>
<span id="cb16-18"><a href="#cb16-18"></a>  runB b</span></code></pre></div>
<p>ところが先のエラーがなぜ起きていたかというと予期しないEApがあったからじゃなイカ。 この変なEApだけごまかせばなんとかなるんじゃなイカ？ どうやらこのEApという型はfromAp関数でEVarを剥き出しにしてからパターンマッチされるようでゲソ。</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1"></a><span class="co">-- File: ajhc/src/E/Type.hs</span></span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="ot">fromAp ::</span> <span class="dt">E</span> <span class="ot">-&gt;</span> (<span class="dt">E</span>,[<span class="dt">E</span>])</span>
<span id="cb17-3"><a href="#cb17-3"></a>fromAp e <span class="ot">=</span> f [] e <span class="kw">where</span></span>
<span id="cb17-4"><a href="#cb17-4"></a>    f as (<span class="dt">EAp</span> e a) <span class="ot">=</span> f (a<span class="op">:</span>as) e</span>
<span id="cb17-5"><a href="#cb17-5"></a>    f as e  <span class="ot">=</span>  (e,as)</span>
<span id="cb17-6"><a href="#cb17-6"></a></span>
<span id="cb17-7"><a href="#cb17-7"></a><span class="co">-- File: ajhc/src/Grin/FromE.hs</span></span>
<span id="cb17-8"><a href="#cb17-8"></a>    ce e <span class="op">|</span> (<span class="dt">EVar</span> tvr,as) <span class="ot">&lt;-</span> fromAp e <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb17-9"><a href="#cb17-9"></a>        as <span class="ot">&lt;-</span> <span class="fu">return</span> <span class="op">$</span> args as</span>
<span id="cb17-10"><a href="#cb17-10"></a>        lfunc <span class="ot">&lt;-</span> asks lfuncMap</span>
<span id="cb17-11"><a href="#cb17-11"></a>        <span class="kw">let</span> fty <span class="ot">=</span> toTypes <span class="dt">TyNode</span> (getType e)</span>
<span id="cb17-12"><a href="#cb17-12"></a>        <span class="kw">case</span> mlookup (tvrIdent tvr) (ccafMap cenv) <span class="kw">of</span></span>
<span id="cb17-13"><a href="#cb17-13"></a>            <span class="dt">Just</span> (<span class="dt">Const</span> c) <span class="ot">-&gt;</span> app fty (<span class="dt">Return</span> [c]) as</span>
<span id="cb17-14"><a href="#cb17-14"></a>            <span class="dt">Just</span> x<span class="op">@</span><span class="dt">Var</span> {} <span class="ot">-&gt;</span> app fty (gEval x) as</span>
<span id="cb17-15"><a href="#cb17-15"></a>            <span class="dt">Nothing</span> <span class="op">|</span> <span class="dt">Just</span> (v,n,rt) <span class="ot">&lt;-</span> mlookup (tvrIdent tvr) lfunc <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb17-16"><a href="#cb17-16"></a>                    <span class="kw">let</span> (x,y) <span class="ot">=</span> <span class="fu">splitAt</span> n as</span>
<span id="cb17-17"><a href="#cb17-17"></a>                    app fty (<span class="dt">App</span> v (keepIts x) rt) y</span>
<span id="cb17-18"><a href="#cb17-18"></a>            <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="kw">case</span> mlookup (tvrIdent tvr) (scMap cenv) <span class="kw">of</span></span>
<span id="cb17-19"><a href="#cb17-19"></a>                <span class="dt">Just</span> (v,as',es)</span>
<span id="cb17-20"><a href="#cb17-20"></a>                    <span class="op">|</span> <span class="fu">length</span> as <span class="op">&gt;=</span> <span class="fu">length</span> as' <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb17-21"><a href="#cb17-21"></a>                        <span class="kw">let</span> (x,y) <span class="ot">=</span> <span class="fu">splitAt</span> (<span class="fu">length</span> as') as</span>
<span id="cb17-22"><a href="#cb17-22"></a>                        app fty (<span class="dt">App</span> v (keepIts x) es) y</span>
<span id="cb17-23"><a href="#cb17-23"></a>                    <span class="op">|</span> <span class="fu">otherwise</span> <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb17-24"><a href="#cb17-24"></a>                        <span class="kw">let</span> pt <span class="ot">=</span> partialTag v (<span class="fu">length</span> as' <span class="op">-</span> <span class="fu">length</span> as)</span>
<span id="cb17-25"><a href="#cb17-25"></a>                        <span class="fu">return</span> <span class="op">$</span> dstore (<span class="dt">NodeC</span> pt (keepIts as))</span>
<span id="cb17-26"><a href="#cb17-26"></a>                <span class="dt">Nothing</span> <span class="op">|</span> <span class="fu">not</span> (isLifted <span class="op">$</span> <span class="dt">EVar</span> tvr) <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb17-27"><a href="#cb17-27"></a>                    mtick' <span class="st">&quot;Grin.FromE.app-unlifted&quot;</span></span>
<span id="cb17-28"><a href="#cb17-28"></a>                    app fty (<span class="dt">Return</span> [toVal tvr]) as</span>
<span id="cb17-29"><a href="#cb17-29"></a>                <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb17-30"><a href="#cb17-30"></a>                    <span class="kw">case</span> as <span class="kw">of</span></span>
<span id="cb17-31"><a href="#cb17-31"></a>                        [] <span class="ot">-&gt;</span> evalVar fty tvr</span>
<span id="cb17-32"><a href="#cb17-32"></a>                        _ <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb17-33"><a href="#cb17-33"></a>                            ee <span class="ot">&lt;-</span> evalVar [<span class="dt">TyNode</span>] tvr</span>
<span id="cb17-34"><a href="#cb17-34"></a>                            app fty ee as</span>
<span id="cb17-35"><a href="#cb17-35"></a>            _ <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="st">&quot;FromE.ce: bad.&quot;</span></span></code></pre></div>
<p>そこでイカのようなfromBang_プリミティブを抹殺する関数を作ったでゲソ!</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb18-1"><a href="#cb18-1"></a><span class="ot">    stripBang ::</span> <span class="dt">E</span> <span class="ot">-&gt;</span> <span class="dt">E</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>    stripBang e <span class="ot">=</span> f e <span class="kw">where</span></span>
<span id="cb18-3"><a href="#cb18-3"></a>      f (<span class="dt">EAp</span> p a) <span class="ot">=</span> g p a</span>
<span id="cb18-4"><a href="#cb18-4"></a>      f e <span class="ot">=</span> e</span>
<span id="cb18-5"><a href="#cb18-5"></a>      g (<span class="dt">EPrim</span> (<span class="dt">PrimPrim</span> <span class="st">&quot;fromBang_&quot;</span>) [b] _) a <span class="ot">=</span> <span class="dt">EAp</span> b a</span>
<span id="cb18-6"><a href="#cb18-6"></a>      g e a <span class="ot">=</span> <span class="dt">EAp</span> e a</span></code></pre></div>
<p>このstripBangを通してからfromApにeを食わせたところ無事エラーが出なくなったでゲソ。 ちょっと危険な気もするが、大目に見てほしいでゲソ。</p>
<h2 id="実装">実装</h2>
<p>ここまで来ればforkOSを実装するのは簡単でゲソ。</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb19-1"><a href="#cb19-1"></a><span class="co">-- File: ajhc/lib/haskell-extras/Control/Concurrent.hs</span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="ot">{-# LANGUAGE ForeignFunctionInterface #-}</span></span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="kw">module</span> <span class="dt">Control.Concurrent</span> (forkOS, <span class="dt">ThreadId</span>) <span class="kw">where</span></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="kw">import</span> <span class="dt">Foreign.Ptr</span></span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="kw">import</span> <span class="dt">Foreign.StablePtr</span></span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="kw">import</span> <span class="dt">Foreign.Storable</span></span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="kw">import</span> <span class="dt">Foreign.Marshal.Alloc</span></span>
<span id="cb19-8"><a href="#cb19-8"></a><span class="kw">import</span> <span class="dt">Control.Monad</span> (when)</span>
<span id="cb19-9"><a href="#cb19-9"></a><span class="kw">import</span> <span class="dt">Jhc.Prim.Rts</span></span>
<span id="cb19-10"><a href="#cb19-10"></a></span>
<span id="cb19-11"><a href="#cb19-11"></a><span class="kw">data</span> <span class="ot">{-# CTYPE &quot;rts/conc.h jhc_threadid_t&quot; #-}</span> <span class="dt">CthreadIdT</span></span>
<span id="cb19-12"><a href="#cb19-12"></a><span class="kw">data</span> <span class="dt">ThreadId</span> <span class="ot">=</span> <span class="dt">ThreadId</span> <span class="dt">CthreadIdT</span></span>
<span id="cb19-13"><a href="#cb19-13"></a></span>
<span id="cb19-14"><a href="#cb19-14"></a>foreign <span class="kw">import</span> ccall &quot;rts/conc.h forkOS_createThread&quot; forkOScreateThread ::</span>
<span id="cb19-15"><a href="#cb19-15"></a>   <span class="dt">FunPtr</span> (<span class="dt">Bang_</span> (<span class="dt">StablePtr</span> (<span class="dt">IO</span> ())) <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Ptr</span> ())) <span class="ot">-&gt;</span> <span class="dt">Bang_</span> a <span class="ot">-&gt;</span> <span class="dt">Ptr</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">CthreadIdT</span></span>
<span id="cb19-16"><a href="#cb19-16"></a></span>
<span id="cb19-17"><a href="#cb19-17"></a><span class="ot">forkOScreateThreadWrapper ::</span> <span class="dt">Bang_</span> (<span class="dt">StablePtr</span> (<span class="dt">IO</span> ())) <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Ptr</span> ())</span>
<span id="cb19-18"><a href="#cb19-18"></a>forkOScreateThreadWrapper b <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb19-19"><a href="#cb19-19"></a>  <span class="kw">let</span> s <span class="ot">=</span> fromBang_ b</span>
<span id="cb19-20"><a href="#cb19-20"></a>  d <span class="ot">&lt;-</span> deRefStablePtr s</span>
<span id="cb19-21"><a href="#cb19-21"></a>  d</span>
<span id="cb19-22"><a href="#cb19-22"></a>  freeStablePtr s</span>
<span id="cb19-23"><a href="#cb19-23"></a>  <span class="fu">return</span> nullPtr</span>
<span id="cb19-24"><a href="#cb19-24"></a></span>
<span id="cb19-25"><a href="#cb19-25"></a>foreign export ccall <span class="st">&quot;forkOScreateThreadWrapper&quot;</span><span class="ot"> forkOScreateThreadWrapper ::</span></span>
<span id="cb19-26"><a href="#cb19-26"></a>  <span class="dt">Bang_</span> (<span class="dt">StablePtr</span> (<span class="dt">IO</span> ())) <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Ptr</span> ())</span>
<span id="cb19-27"><a href="#cb19-27"></a>foreign <span class="kw">import</span> ccall &quot;&amp;forkOScreateThreadWrapper&quot; p_forkOScreateThreadWrapper ::</span>
<span id="cb19-28"><a href="#cb19-28"></a>  <span class="dt">FunPtr</span> (<span class="dt">Bang_</span> (<span class="dt">StablePtr</span> (<span class="dt">IO</span> ())) <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Ptr</span> ()))</span>
<span id="cb19-29"><a href="#cb19-29"></a></span>
<span id="cb19-30"><a href="#cb19-30"></a><span class="ot">forkOS ::</span> <span class="dt">IO</span> () <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">ThreadId</span></span>
<span id="cb19-31"><a href="#cb19-31"></a>forkOS f <span class="ot">=</span> alloca <span class="op">$</span> \ip <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb19-32"><a href="#cb19-32"></a>  s <span class="ot">&lt;-</span> newStablePtr f</span>
<span id="cb19-33"><a href="#cb19-33"></a>  pth <span class="ot">&lt;-</span> forkOScreateThread p_forkOScreateThreadWrapper (toBang_ s) ip</span>
<span id="cb19-34"><a href="#cb19-34"></a>  i <span class="ot">&lt;-</span> peek ip</span>
<span id="cb19-35"><a href="#cb19-35"></a>  when (i <span class="op">/=</span> <span class="dv">0</span>) <span class="op">$</span> <span class="fu">fail</span> <span class="st">&quot;Cannot create OS thread.&quot;</span></span>
<span id="cb19-36"><a href="#cb19-36"></a>  <span class="fu">return</span> <span class="op">$</span> <span class="dt">ThreadId</span> pth</span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb20-1"><a href="#cb20-1"></a><span class="co">// File: ajhc/rts/rts/conc.c</span></span>
<span id="cb20-2"><a href="#cb20-2"></a>jhc_threadid_t</span>
<span id="cb20-3"><a href="#cb20-3"></a>forkOS_createThread(<span class="dt">void</span> *(*wrapper) (<span class="dt">void</span> *), <span class="dt">void</span> *entry, <span class="dt">int</span> *err)</span>
<span id="cb20-4"><a href="#cb20-4"></a>{</span>
<span id="cb20-5"><a href="#cb20-5"></a>        pthread_t tid;</span>
<span id="cb20-6"><a href="#cb20-6"></a>        *err = pthread_create(&amp;tid, NULL, wrapper, entry);</span>
<span id="cb20-7"><a href="#cb20-7"></a>        <span class="cf">if</span> (*err) {</span>
<span id="cb20-8"><a href="#cb20-8"></a>                pthread_detach(tid);</span>
<span id="cb20-9"><a href="#cb20-9"></a>        }</span>
<span id="cb20-10"><a href="#cb20-10"></a>        <span class="cf">return</span> tid;</span>
<span id="cb20-11"><a href="#cb20-11"></a>}</span></code></pre></div>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p><a href="http://itpro.nikkeibp.co.jp/article/COLUMN/20080805/312151/?ST=develop&amp;P=4">本物のプログラマはHaskellを使う - 第22回　FFIを使って他の言語の関数を呼び出す：ITpro</a><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
<p>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname = 'metasepi';
    var disqus_identifier = '/posts/2013-06-20-forkos_jhc.html';
    var disqus_url = 'https://metasepi.org' + '/posts/2013-06-20-forkos_jhc.html';
    var disqus_title = 'Build forkOS API using pthread.';
    var disqus_developer = 1;
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>
    Please enable JavaScript to view the 
    <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
  </noscript>
  <a href="http://disqus.com" class="dsq-brlink">
    blog comments powered by <span.logo-disqus>Disqus</span>
  </a>
</p>

    </div>

    <footer>
      <p>
        This page is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>. <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/80x15.png" /></a>
        <br>
        Metasepi project is supported by
        <a href="https://systemi.co.jp/"><img alt="SYSTEM I" style="border-width:0" src="../img/systemi_22x25.png" /></a> ×
        <a href="http://www.metasepi-design.com/"><img alt="METASEPI DESIGN" style="border-width:0" src="../img/metasepi_design_logo_82x25.png" /></a> ×
        <a href="../past-supporters.html">Past Supporters</a>
      </p>
    </footer>
  </div>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="/js/libs/jquery-1.6.2.min.js"><\/script>')</script>

  <!-- scripts concatenated and minified via ant build script-->
  <script defer src="../js/plugins.js"></script>
  <script defer src="../js/script.js"></script>
  <!-- end scripts-->

  <script>
    window._gaq = [['_setAccount','UA-158383-8'],['_trackPageview'],['_trackPageLoadTime']];
    Modernizr.load({
      load: ('https:' == location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js'
    });
  </script>

  <!--[if lt IE 7 ]>
    <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js">
    <script>
      window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})
  <![endif]-->
</body>
